\ProvidesPackage{style}

\usepackage{geometry}


%Color related stuff
\usepackage[usenames,dvipsnames]{xcolor}
\definecolor{darkblue}{RGB}{0,0,90}
\definecolor{darkgreen}{RGB}{0,80,0}
\definecolor{gray75}{gray}{0.8}


%Image captions
\usepackage[format=hang]{caption}
\renewcommand{\captionlabelfont}{\fontfamily{phv}\selectfont\bfseries\small}


%links and urls (internal AND external)
\usepackage{hyperref}
\usepackage{url}
\hypersetup{colorlinks=true,pdfborder={0 0 0},citecolor=darkblue,linkcolor=darkblue,urlcolor=darkblue}


\usepackage[varg]{txfonts}


%Titles of content
\usepackage{tocloft}
\setcounter{tocdepth}{3}

\renewcommand{\cftdot}{\textcolor[gray]{0.75}{--}}
\renewcommand{\cftdotsep}{0}
\renewcommand{\cftchapfont}{\fontfamily{phv}\selectfont\bfseries}
\renewcommand{\contentsname}{C \hsp \textcolor[gray]{0.75}{ \rule[-0.75ex]{0.08ex}{1.5em} }\hsp Contents}



%Margin notes
\usepackage{marginnote,letltxmacro}
%\usepackage{marginnote}
\usepackage{etoolbox}

%\renewcommand*{\raggedleftmarginnote}{\centering}
\renewcommand*{\marginnoteleftadjust}{12.4cm}

%\reversemarginpar
\renewcommand*{\marginfont}{\footnotesize}
\LetLtxMacro\mnote\marginnote


%symbols for footnotes
\usepackage[perpage]{footmisc}
%\newcommand{\mfootnote}{\fnsymbol{footnote}}
%\makeatletter
%\def\@xfootnote[#1]{%
%  \protected@xdef\@thefnmark{#1}%
%  \@footnotemark\@footnotetext}
%\makeatother




%Double column footnotes
%\usepackage{dblfnote}
%\DFNalwaysdouble % for this example

%\usepackage[noreledmac]{eledmac}
%\usepackage{etoolbox}
%\patchcmd{\twocolfootfmtX}{\raggedright}{}{}{}
%\foottwocolX{A}
%\let\footnote\footnoteA
%\usepackage{lipsum}
%\setlength{\parskip}{0pt}


% Quotes
\usepackage{csquotes}




%Some baseline lengths for styles
%\usepackage{dblfnote}
%\DFNalwaysdouble % for this example

\def\hsp{\hspace{10pt}}
\def\dsp{\hspace{20pt}}


%Defining titles with fancy fonts
\usepackage[compact]{titlesec}
\titleformat{\section}[hang]{\fontfamily{phv}\selectfont\bfseries}{\thesection\hsp}{0pt}{}{}
\titleformat{\subsection}[hang]{\fontfamily{phv}\selectfont}{\thesubsection\hsp}{0pt}{}{}
\titleformat{\subsubsection}[hang]{\fontfamily{phv}\selectfont\itshape}{\hsp}{0pt}{}{}

\titleformat{\chapter}[hang]{\Huge\fontfamily{phv}\selectfont}{\thechapter\hsp{\textcolor{gray75}{\rule[-0.75ex]{0.08ex}{1.5em}}}\hsp}{0pt}{\huge\bfseries}{}


%\renewcommand{\titlefont}{\Huge\fontfamily{phv}\selectfont\bfseries}
\newcommand*{\titlefont}{\Huge\fontfamily{phv}\selectfont\bfseries}



% page headers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}

\renewcommand{\headrulewidth}{0pt}
\renewcommand{\headrulewidth}{0.5pt}
\renewcommand{\footrulewidth}{0.0pt}
\renewcommand{\chaptermark}[1]{\markboth{\fontfamily{phv}\selectfont\chaptername\ \thechapter:\ #1}{}}
\fancyhead[LE]{\fontfamily{phv}\selectfont \leftmark}
\fancyhead[RE]{}
\fancyhead[LO]{}
\fancyhead[RO]{\fontfamily{phv}\selectfont \nouppercase\rightmark}
\renewcommand{\sectionmark}[1]{\markright{\arabic{chapter}.\arabic{section} \, #1}}





%-------------------------------------------------- 
%\usepackage{graphicx,eso-pic}
%\newcommand\chapterimage[2][]{%
%  \AddToShipoutPictureBG*{% Add picture to BackGround on this page only
%    \AtTextUpperLeft{% Position at upper left of text block
%      \hspace*{\textwidth}% Move over to upper right of text block
%      \llap{% Ignore horizontal width and overlap to the left
%        \smash{% Ignore vertical height
%          \raisebox{-\height}{% Lower so top touches baseline
%            \includegraphics[#1]{#2}}}}}}}% Include image with options

\usepackage{tikz}% mandatory for the \chapterImage command
%\newcommand\chapterimage[2][]{
%  \begin{tikzpicture}[overlay,
%      picture/.style={anchor=north east,rectangle,inner sep=0pt,outer sep=0pt, shift={(-4cm, -2cm)}}]
%     \node[picture] at (\textwidth,9cm){\includegraphics[#1]{#2}};
%  \end{tikzpicture}
%}
\newcommand\chapterimage[2][]{
  \begin{tikzpicture}[overlay,
      picture/.style={anchor=east,rectangle, shift={(0.0cm, -4cm)}}]
     \node[picture] at (\textwidth,9cm){\includegraphics[#1]{#2}};
  \end{tikzpicture}
}

%-------------------------------------------------- 
%Citation formatting
%\usepackage[style=numeric-comp, 
%            backend=biber,
%            mincitenames=1,
%            maxcitenames=3,
%            maxbibnames=100,
%            backref=true, 
%            sorting=none]{biblatex}
\usepackage[style=numeric-comp,sorting=none,citetracker,pagetracker=page]{biblatex}

\input{journals}

\renewbibmacro{in:}{}

\DeclareFieldFormat[article]{year}{(#1)}
\DefineBibliographyStrings{english}{andothers={\emph{et al}\adddot}}




% https://tex.stackexchange.com/questions/71526/repeat-the-same-reference-in-footnote-on-different-pages

\makeatletter
% user-level citation command
\DeclareCiteCommand{\sfcite}[\cbx@superscript]
  {\usebibmacro{cite:init}%
   \let\multicitedelim\supercitedelim
   \iffieldundef{prenote}{}{\BibliographyWarning{Ignoring prenote argument}}%
   \iffieldundef{postnote}{}{\BibliographyWarning{Ignoring postnote argument}}}
  {\usebibmacro{citeindex}%
   \usebibmacro{cite:super:foot}%
   \usebibmacro{cite:comp}}
  {}
  {\usebibmacro{cite:dump}}

% save instcount, save key and last inline instcount if seen first on page
\newbibmacro*{cite:super:foot}{%
  \xdef\cbx@key{\thefield{entrykey}}%
  \ifsamepage{\value{instcount}}{\csuse{cbx@instcount@\cbx@key}}{}{%
    \listxadd{\cbx@savelist}{\cbx@key}%
    \ifnumequal{\value{cbx@tempcntd}}{0}{%
      \defcounter{cbx@tempcntc}{\value{instcount}}%
      \loop\ifnum\value{cbx@tempcntc}>0
        \ifsamepage{\value{instcount}}{\value{cbx@tempcntc}}
          {\ifcsundef{blx@fnpage@\number\numexpr\value{cbx@tempcntc}}
             {\setcounter{cbx@tempcntd}{\value{cbx@tempcntc}}}{}%
           \stepcounter{cbx@tempcntc}}
          {\setcounter{cbx@tempcntc}{0}}%
      \repeat}{}}%
  \csnumgdef{cbx@instcount@\cbx@key}{\value{instcount}}}
\let\cbx@savelist\@empty
\newcounter{cbx@tempcntc}
\newcounter{cbx@tempcntd}
\setcounter{cbx@tempcntd}{0}

\newrobustcmd*{\cbx@superscript}[1]{%
  \global\toggletrue{cbx@sfcite}
  \mkbibsuperscript{#1}%
  \cbx@footnote%
  \global\togglefalse{cbx@sfcite}}
\newtoggle{cbx@sfcite}

\AtEveryCitekey{%
  \ifciteseen{}{\csnumgdef{cbx@instcount@\thefield{entrykey}}{-1}}%
  \iftoggle{cbx@sfcite}{}{\cbx@footnote}}
\AtEveryBibitem{\cbx@footnote}
\AtEveryLositem{\cbx@footnote}

% defer citation footnotes to last inline reference instance on page
\newrobustcmd*{\cbx@footnote}{%
  \ifboolexpr{ not test {\ifdefempty{\cbx@savelist}}
               and test {\ifnumequal{\value{instcount}}{\value{cbx@tempcntd}}} }
    {\cbx@sortlist@init%
     \let\do\cbx@do
     \dolistloop{\cbx@sortlist}%
     \global\let\cbx@savelist\@empty
     \setcounter{cbx@tempcntd}{0}}{}}

% print footnotes in 'sorting' order
\def\cbx@do#1{%
  \ifinlist{#1}{\cbx@savelist}
    {\begingroup
     \blx@resetdata
     \blx@getdata@cite{#1}%
     \blx@setoptions@type\abx@field@entrytype
     \blx@setoptions@entry
     \blx@execute
     \blx@beglang
     \iffieldundef{shorthand}
       {\gdef\@thefnmark{\printfield{labelprefix}\printfield{labelnumber}}}
       {\gdef\@thefnmark{\printfield{shorthand}}}%
     \gappto\@thefnmark{\blx@initunit}%
     \ifhyperref
       {\H@@footnotetext{
           \printnames{author}
           \setunit{\labelnamepunct}
           \printfield{journaltitle}
           \newunit
           \printfield{year}
       }}
       {\@footnotetext{
           \printnames{author}
           \setunit{\labelnamepunct}
           \printfield{journaltitle}
           \newunit
           \printfield{year}
       }}%
     \blx@endlang
     \endgroup}
    {}}


       %{\H@@footnotetext{\blx@driver\abx@field@entrytype}}
       %{\@footnotetext{\blx@driver\abx@field@entrytype}}%


%{\usebibmacro{prenote}}{
%    \usebibmacro{citeindex}
%    \mkbibbrackets{\usebibmacro{cite}}
%    \setunit{\addnbspace}
%    \printnames{author}
%    \setunit{\labelnamepunct}
%    \printfield{journaltitle}
%    \newunit
%    \printfield{year}
%}

% access internal list of sorted entry keys
\def\cbx@sortlist@init{%
  \global\letcs{\cbx@sortlist}
    {blx@slist@entry@\the\c@refsection @\blx@refcontext@context}}
\let\cbx@sortlist\@empty
\makeatother


% Own citation command
\renewcommand*{\thefootnote}{\fnsymbol{footnote}}


%Separate driver for the bibliography listing
\DeclareBibliographyDriver{article}{
\usebibmacro{bibindex}
\usebibmacro{begentry}
\newunit\newblock
\printnames{author}
\newunit\newblock
\usebibmacro{journal}
\newunit\newblock
\printfield{volume}
\newunit\newblock
\printfield{number}
\newunit\newblock
\usebibmacro{note+pages}
\newunit\newblock
\printfield{year}
\newunit\newblock
\usebibmacro{pageref}
\newline\newblock
\printfield{title}
{\iffieldundef{doi}{
    {\iffieldundef{url}
    {}
    {\newline\newblock
    \usebibmacro{doi+eprint+url}}
    {}
    }
}
{\newline\newblock
\usebibmacro{doi+eprint+url}}
{}
}
\finentry}

\DefineBibliographyStrings{english}{
backrefpage = {see p.},
backrefpages = {see pp.}
}


\renewbibmacro*{doi+eprint+url}{
\iftoggle{bbx:doi}
{\iffieldundef{url}{\printfield{doi}}{}}{}
\iftoggle{bbx:eprint}
{\iffieldundef{doi}{\usebibmacro{eprint}}{}}{}
\iftoggle{bbx:url}
{\usebibmacro{url+urldate}}{}
}






